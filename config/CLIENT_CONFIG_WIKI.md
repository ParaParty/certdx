# CertDX Client Configuration Wiki

## Overview

**CertDX Client** is the client component of the CertDX certificate daemon. It connects to a CertDX server to retrieve certificates for specified domains. The client caches certificates locally and automatically reloads services when certificates are renewed.

CertDX supports multiple client implementations:
- Standalone command-line client
- Caddy plugin client
- Envoy client (via SDS - Secret Discovery Service)

This wiki documents the `client_config_full.toml` configuration file for the standalone client.

---

## Configuration Sections

### [Common] - Common Client Settings

Basic configuration shared across all client modes.

#### `retryCount` (integer)
- **Description**: Number of times to retry operations on failure
- **Example**: `retryCount = 5`
- **Default**: Recommended value is 3-5
- **Note**: Applies to server connection attempts and certificate retrieval

#### `mode` (string)
- **Description**: Communication protocol to use when connecting to the CertDX server
- **Supported Values**:
  - `"http"` - HTTP/HTTPS protocol
  - `"grpc"` - gRPC protocol with mTLS
- **Example**: `mode = "http"`
- **Recommendation**: Use `"http"` for simpler setups, `"grpc"` for production environments requiring mTLS

#### `reconnectInterval` (duration string)
- **Description**: Interval for reconnection attempts when server connection is lost
- **Format**: Go duration string (e.g., "10m", "5m", "30s")
- **Example**: `reconnectInterval = "10m"`
- **Applies To**: gRPC mode only
- **Behavior**:
  - If client loses connection from main server or standby server, reconnect attempt every interval
  - If client falls back to standby server, retry connecting to main server every interval

---

## HTTP Mode Configuration

### [Http.MainServer] - Primary HTTP Server

Configures connection to the primary CertDX HTTP server.

#### `url` (string)
- **Description**: Full URL to the CertDX server's API endpoint
- **Format**: `"https://[host]:[port]/[apiPath]"` or `"http://[host]:[port]/[apiPath]"`
- **Example**: `"https://certdxserver.example.com:19198/1145141919810"`
- **Note**: The `apiPath` must match the server's configuration
- **HTTPS Recommended**: Use HTTPS for production deployments

#### `authMethod` (string)
- **Description**: Authentication method to use
- **Supported Values**:
  - `"token"` - Token-based authentication
  - `"mtls"` - Mutual TLS authentication
- **Example**: `authMethod = "token"`

##### Token Authentication
```toml
authMethod = "token"
token = "your-secret-token"
```
- **token**: Secret token that matches the server's token configuration
- **Security**: Use strong, randomly generated tokens

##### mTLS Authentication
```toml
authMethod = "mtls"
ca = "/path/to/ca.pem"
certificate = "/path/to/client/cert.pem"
key = "/path/to/client/private.key"
```
- **ca**: Path to CA certificate file
- **certificate**: Path to client certificate file
- **key**: Path to client private key file
- **Note**: Generate these files using `certdx_tools make-ca`, `certdx_tools make-client`

### [Http.StandbyServer] - Backup HTTP Server

Configures connection to a secondary CertDX HTTP server for failover.

#### `url` (string)
- **Description**: Full URL to the backup CertDX server's API endpoint
- **Format**: Same as `[Http.MainServer]`
- **Example**: `"http://mybackupserver.local:11451/1919810"`
- **Optional**: Can be omitted if no failover is needed
- **Failover Behavior**: Client automatically falls back to standby server if main server is unreachable

---

## gRPC Mode Configuration

### [GRPC.MainServer] - Primary gRPC Server

Configures connection to the primary CertDX gRPC server using mTLS.

#### `server` (string)
- **Description**: Network address and port of the gRPC server
- **Format**: `"[host]:[port]"`
- **Example**: `"grpc.example.com:9999"`

#### `ca` (string)
- **Description**: Path to the CA certificate file for mTLS
- **Path Type**: Relative to certdx_client executable
- **Example**: `"./mtls/ca.pem"`
- **Location**: `certdx_client_executable_path/mtls/ca.pem`
- **Source**: Copy from server's `mtls/ca.pem` (generated by `certdx_tools make-ca`)
- **Note**: Must match the CA used by the server; same for all clients

#### `certificate` (string)
- **Description**: Path to the client certificate file for mTLS
- **Path Type**: Relative to certdx_client executable
- **Example**: `"./mtls/client-app-1.pem"`
- **Location**: `certdx_client_executable_path/mtls/<client-name>.pem`
- **Source**: Copy from server's `mtls/<client-name>.pem` (generated by `certdx_tools make-client -n <client-name>`)
- **Note**: Each client gets a unique certificate; same server can have different certificates for different clients

#### `key` (string)
- **Description**: Path to the client private key file for mTLS
- **Path Type**: Relative to certdx_client executable
- **Example**: `"./mtls/client-app-1.key"`
- **Location**: `certdx_client_executable_path/mtls/<client-name>.key`
- **Source**: Copy from server's `mtls/<client-name>.key` (generated by `certdx_tools make-client -n <client-name>`)
- **Security**: Keep private and restrict file permissions to client process only (e.g., `chmod 600 mtls/client-app-1.key`)

### [GRPC.StandbyServer] - Backup gRPC Server

Configures connection to a secondary CertDX gRPC server for failover.

#### `server` (string)
- **Description**: Network address and port of the backup gRPC server
- **Format**: `"[host]:[port]"` (hostname or IP address)
- **Example**: `"192.168.1.2:9090"`

#### `ca`, `certificate`, `key`
- **Description**: Same as `[GRPC.MainServer]`
- **ca**: Can reuse the same `ca.pem` (generated from the CA on either server)
- **certificate, key**: If both servers are in the same cluster, can reuse same client certificate. If different clusters, use different client certificates generated from each server's CA
- **Best Practice**: For redundancy within same cluster, reuse same client certificate. For different clusters, generate separate certificates.

---

## Certificate Management

### [[Certifications]] - Certificate Configuration Array

Defines certificates to retrieve and manage. Use multiple `[[Certifications]]` sections for multiple certificates.

#### `name` (string)
- **Description**: Identifier for this certificate set
- **Usage**: Used as filename prefix when saving certificates
- **Example**: `name = "certFileNameToSave"`
- **Saved Files**: 
  - Certificate: `{savePath}/{name}.pem`
  - Key: `{savePath}/{name}.key`

#### `savePath` (string)
- **Description**: Directory path where certificates and keys are saved
- **Path Type**: Absolute path
- **Example**: `savePath = "/path/to/directory/which/saves/your/certifications"`
- **Permissions**: Client process must have read/write access to this directory

#### `domains` (string array)
- **Description**: List of domain names to include in this certificate
- **Example**:
  ```toml
  domains = [
      "*.example.com",
      "*.mm.example.com",
  ]
  ```
- **Wildcard Support**: Wildcards (e.g., `*.example.com`) are supported
- **Multiple Domains**: A single certificate can cover multiple domains (SAN - Subject Alternative Name)
- **Server Requirement**: All domains must be in the server's `allowedDomains` list

#### `reloadCommand` (string)
- **Description**: Shell command to execute when certificate is updated
- **Example**: `reloadCommand = "systemctl reload nginx"`
- **Alternative**: `reloadCommand = "bash /opt/acme/reload.sh"`
- **Purpose**: Reload services (e.g., web server, reverse proxy) with new certificates
- **Execution**: Runs with the privileges of the client process
- **Optional**: Can be omitted if manual reload is acceptable
- **Script Example**:
  ```bash
  #!/bin/bash
  systemctl reload nginx
  systemctl reload envoy
  # or any custom reload logic
  ```

---

## Configuration Examples

### Example 1: Simple HTTP Mode with Token Authentication

```toml
[Common]
retryCount = 3
mode = "http"

[Http.MainServer]
url = "https://certdx.example.com:19198/api"
authMethod = "token"
token = "your-secure-token"

[[Certifications]]
name = "mysite"
savePath = "/etc/ssl/certs"
domains = [
    "*.example.com",
    "example.com",
]
reloadCommand = "systemctl reload nginx"
```

### Example 2: HTTP Mode with Failover and mTLS

```toml
[Common]
retryCount = 5
mode = "http"

[Http.MainServer]
url = "https://certdx-primary.example.com:19198/api"
authMethod = "mtls"
ca = "/etc/ssl/certs/certdx-ca.pem"
certificate = "/etc/ssl/certs/certdx-client.pem"
key = "/etc/ssl/private/certdx-client.key"

[Http.StandbyServer]
url = "https://certdx-backup.example.com:19198/api"

[[Certifications]]
name = "web"
savePath = "/etc/ssl/private"
domains = ["*.example.com"]
reloadCommand = "systemctl reload nginx"

[[Certifications]]
name = "api"
savePath = "/etc/ssl/private"
domains = ["api.example.com", "*.api.example.com"]
reloadCommand = "systemctl restart myapi"
```

### Example 3: gRPC Mode with Primary and Backup Servers

```toml
[Common]
retryCount = 5
mode = "grpc"
reconnectInterval = "5m"

[GRPC.MainServer]
server = "certdx-1.local:9999"
ca = "./mtls/ca.pem"
certificate = "./mtls/certdx-client.pem"
key = "./mtls/certdx-client.key"

[GRPC.StandbyServer]
server = "certdx-2.local:9999"
ca = "./mtls/ca.pem"
certificate = "./mtls/certdx-client.pem"
key = "./mtls/certdx-client.key"

[[Certifications]]
name = "frontend"
savePath = "/opt/myapp/certs"
domains = ["*.myapp.com"]
reloadCommand = "bash /opt/myapp/reload-certs.sh"

[[Certifications]]
name = "backend"
savePath = "/opt/myapp/certs"
domains = ["*.backend.myapp.com", "*.internal.myapp.com"]
reloadCommand = "bash /opt/myapp/reload-backend.sh"
```

### Example 4: Multiple Certificates with Caddy Integration

```toml
[Common]
retryCount = 5
mode = "http"

[Http.MainServer]
url = "https://certdx.example.com:19198/secure-api"
authMethod = "token"
token = "your-secure-token-here"

[[Certifications]]
name = "caddy-main"
savePath = "/etc/caddy/certs"
domains = ["example.com", "*.example.com"]
reloadCommand = "systemctl reload caddy"

[[Certifications]]
name = "caddy-blog"
savePath = "/etc/caddy/certs"
domains = ["blog.example.com", "*.blog.example.com"]
reloadCommand = "systemctl reload caddy"
```

---

## Security Best Practices

1. **Token Security**: Use strong, randomly generated tokens for token-based authentication
2. **mTLS Preferred**: For production, use mTLS authentication instead of token-based
3. **File Permissions**:
   - Private key files should be readable only by the client process (e.g., `chmod 600`)
   - Certificate and CA files should be readable by relevant services (e.g., `chmod 644`)
4. **Configuration Security**: Keep configuration file private; it may contain sensitive information
5. **Reload Commands**: Ensure reload commands are secure and properly quoted
6. **Directory Ownership**: Ensure certificate save directories are owned by appropriate users

---

## Common Tasks

### Adding a New Certificate

1. Add a new `[[Certifications]]` section to your config:
   ```toml
   [[Certifications]]
   name = "mynewcert"
   savePath = "/path/to/certs"
   domains = ["domain1.com", "domain2.com"]
   reloadCommand = "your-reload-command"
   ```

2. Restart the CertDX client
3. Client will request certificate from server and save it to the specified path

### Switching from HTTP to gRPC Mode

1. **On the server**, generate mTLS certificates:
   ```bash
   # Generate CA (once)
   certdx_tools make-ca
   
   # Generate server certificate
   certdx_tools make-server -d grpc.example.com
   
   # Generate client certificate for this client
   certdx_tools make-client -n my-client-name
   ```

2. **On the client**, place certificate files in the `mtls/` directory:
   ```bash
   # Navigate to the certdx_client executable directory
   cd /path/to/certdx_client/
   
   # Create mtls directory if it doesn't exist
   mkdir -p mtls
   
   # Copy from server's mtls directory:
   scp user@server:/path/to/certdx/mtls/ca.pem mtls/
   scp user@server:/path/to/certdx/mtls/my-client-name.pem mtls/
   scp user@server:/path/to/certdx/mtls/my-client-name.key mtls/
   
   # Secure the private key
   chmod 600 mtls/my-client-name.key
   ```

3. Update `[Common]` section:
   ```toml
   mode = "grpc"
   reconnectInterval = "10m"
   ```

4. Configure `[GRPC.MainServer]` with paths relative to the certdx_client executable:
   ```toml
   [GRPC.MainServer]
   server = "grpc.example.com:9999"
   ca = "./mtls/ca.pem"
   certificate = "./mtls/my-client-name.pem"
   key = "./mtls/my-client-name.key"
   ```

5. Remove or comment out `[Http.MainServer]` and `[Http.StandbyServer]`

6. Restart the client

### Setting Up Failover

1. Configure both main and standby servers
2. Client automatically detects main server failure
3. Falls back to standby server
4. Periodically attempts to reconnect to main server (every `reconnectInterval`)

### Testing Certificate Retrieval

1. Verify server connectivity:
   ```bash
   curl -k https://certdxserver.example.com:19198/api  # HTTP mode
   grpcurl -plaintext localhost:9999 list                # gRPC mode
   ```

2. Check client logs for any errors
3. Verify certificate files appear in `savePath` directories

---

## Troubleshooting

### Client Cannot Connect to Server

- **HTTP Mode**: Verify `url` is correct and server is running
- **gRPC Mode**: Verify `server` address is reachable and port is correct
- **Firewall**: Check firewall rules allow connection on specified port

### Certificate Not Saved

- **Path Permissions**: Ensure client process has write access to `savePath`
- **Directory Exists**: Create `savePath` directory if it doesn't exist
- **Domains**: Verify all `domains` are in server's `allowedDomains` list

### Reload Command Not Executing

- **Command Path**: Verify command path is absolute or in PATH
- **Permissions**: Ensure client process has permission to execute command
- **Syntax**: Check command syntax is correct (shell-escaped if needed)
- **Logs**: Check client logs for command execution errors

### mTLS Connection Fails

- **Certificates**: Verify certificate and key files exist at specified paths
- **CA Certificate**: Ensure CA certificate matches server's CA
- **Permissions**: Ensure client process can read certificate files
- **Certificate Validity**: Verify certificates are not expired or revoked

---

## File References

- `client_config_full.toml` - Full example configuration with all options
- `client_config.toml` - Minimal production configuration
- Use `client_config_full.toml` as a template to understand all available options
