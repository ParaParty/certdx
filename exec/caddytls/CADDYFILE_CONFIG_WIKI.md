# Caddy CertDX Plugin Configuration Wiki

## Overview

The **Caddy CertDX Plugin** integrates CertDX certificate management directly into Caddy web server. This allows Caddy to dynamically retrieve certificates from a CertDX server instead of using Caddy's built-in ACME client.

The plugin uses the same configuration concepts as the standalone CertDX client, but expressed in Caddyfile format rather than TOML.

---

## Configuration Sections

### `certdx` Block - Main Plugin Configuration

The `certdx` block contains the main configuration for the CertDX plugin. This is where you configure how Caddy connects to the CertDX server and how certificates are managed.

#### `retry_count` (integer)
- **Description**: Number of times to retry operations on failure
- **Example**: `retry_count 10`
- **Default**: Recommended value is 3-5
- **Note**: Applies to server connection attempts and certificate retrieval

#### `mode` (string)
- **Description**: Communication protocol to use when connecting to the CertDX server
- **Supported Values**:
  - `http` - HTTP/HTTPS protocol
  - `grpc` - gRPC protocol with mTLS
- **Example**: `mode grpc`
- **Recommendation**: Use `http` for simpler setups, `grpc` for production environments requiring mTLS

#### `reconnect_interval` (duration string)
- **Description**: Interval for reconnection attempts when server connection is lost
- **Format**: Duration string (e.g., "15m", "10m", "30s")
- **Example**: `reconnect_interval 15m`
- **Applies To**: gRPC mode only
- **Behavior**:
  - If connection to main server is lost, reconnect attempt every interval
  - If fallback to standby server occurs, retry main server every interval

---

## HTTP Mode Configuration

### `http` Block - HTTP Server Settings

Configures connection to CertDX HTTP servers.

#### `main_server` Block

Configures the primary CertDX HTTP server.

##### `url` (string)
- **Description**: Full URL to the CertDX server's API endpoint
- **Format**: `https://[host]:[port]/[apiPath]` or `http://[host]:[port]/[apiPath]`
- **Example**: `url https://certdxserver.example.com:19198/certdx-api`
- **Note**: The `apiPath` must match the server's configuration
- **HTTPS Recommended**: Use HTTPS for production deployments

##### `authMode` (string)
- **Description**: Authentication method to use
- **Supported Values**:
  - `token` - Token-based authentication
  - `mtls` - Mutual TLS authentication
- **Example**: `authMode token`

##### `token` (string)
- **Description**: Authentication token for token-based authentication
- **Example**: `token your-secret-token`
- **Security**: Use strong, randomly generated tokens
- **Note**: Only used if `authMode = token`

##### mTLS Authentication Alternative

For mTLS authentication instead of token:

```
main_server {
    url https://certdx.example.com:9999/api
    authMode mtls
    ca /path/to/ca.pem
    certificate /path/to/client.pem
    key /path/to/client.key
}
```

- **ca**: Path to CA certificate file
- **certificate**: Path to client certificate file
- **key**: Path to client private key file

#### `standby_server` Block (Optional)

Configures backup CertDX HTTP server for failover:

```
standby_server {
    url https://certdx-backup.example.com:9999/api
    token YOUR_TOKEN
}
```

- Same parameters as `main_server`
- Optional; client will fall back here if main server is unreachable

---

## gRPC Mode Configuration

### `GRPC` Block - gRPC Server Settings

Configures connection to CertDX gRPC servers using mTLS.

#### `main_server` Block

Configures the primary CertDX gRPC server.

##### `server` (string)
- **Description**: Network address and port of the gRPC server
- **Format**: `[host]:[port]`
- **Example**: `server grpc.example.com:9999`

##### `ca` (string)
- **Description**: Path to the CA certificate file for mTLS
- **Example**: `ca /opt/certdx/mtls/ca_remote.pem`
- **Source**: Copy from server's `mtls/ca.pem` (generated by `certdx_tools make-ca`)
- **Note**: Must match the CA used by the server

##### `certificate` (string)
- **Description**: Path to the client certificate file for mTLS
- **Example**: `certificate /opt/certdx/mtls/itxsh.pem`
- **Source**: Copy from server's `mtls/<client-name>.pem` (generated by `certdx_tools make-client -n <client-name>`)
- **Note**: Each Caddy instance gets a unique certificate

##### `key` (string)
- **Description**: Path to the client private key file for mTLS
- **Example**: `key /opt/certdx/mtls/itxsh.key`
- **Source**: Copy from server's `mtls/<client-name>.key`
- **Security**: Keep private and restrict file permissions

#### `standby_server` Block (Optional)

Configures backup CertDX gRPC server for failover:

```
standby_server {
    server certdx-backup.example.com:9999
    ca /opt/certdx/mtls/ca_remote.pem
    certificate /opt/certdx/mtls/itxsh.pem
    key /opt/certdx/mtls/itxsh.key
}
```

- Same parameters as `main_server`
- Optional; for high availability setups

---

## Certificate Configuration

### `certificate` Block - Certificate Declaration

Declares certificates to retrieve from CertDX server.

#### Block Name (string)
- **Description**: Identifier for this certificate set (used as reference)
- **Example**: `certificate wildcharhyuki { ... }`
- **Usage**: Referenced in `get_certificate` directive in HTTPS site blocks

#### Domain List

Domains to include in the certificate:

```
certificate mycert {
    *.example.com
    example.com
}
```

- **Wildcard Support**: Wildcards (e.g., `*.example.com`) are supported
- **Multiple Domains**: A single certificate can cover multiple domains (SAN - Subject Alternative Name)
- **Server Requirement**: All domains must be in the server's `allowedDomains` list

---

## Using Certificates in HTTPS Sites

### `get_certificate` Directive

Use the `get_certificate` directive within a site block to apply certificates:

```
https://example.com:443 {
    tls {
        get_certificate certdx mycert
    }
    
    # ... rest of site configuration
}
```

**Parameters:**
- First parameter: `certdx` (plugin name)
- Second parameter: Certificate identifier (from `certificate` block)

**Example from Caddyfile:**

```
https://example.com:443 {
    tls {
        get_certificate certdx mycert
    }

    reverse_proxy localhost:9090
}
```

- Applies `mycert` certificate (containing `*.example.com`)
- HTTPS listens on port 443
- Proxies traffic to local service on port 9090

---

## Complete Configuration Examples

### Example 1: HTTP Mode with Token Authentication

```
{
    auto_https off
}

certdx {
    retry_count 5
    mode http

    http {
        main_server {
            url https://certdxserver.example.com:19198/1145141919810
            authMode token
            token your-secret-token-here
        }
    }

    certificate mainsite {
        example.com
        *.example.com
    }
}

https://example.com {
    tls {
        get_certificate certdx mainsite
    }

    reverse_proxy localhost:8080
}

https://app.example.com {
    tls {
        get_certificate certdx mainsite
    }

    reverse_proxy localhost:8081
}
```

### Example 2: gRPC Mode with Primary and Backup Servers

```
{
    auto_https off
}

certdx {
    retry_count 10
    mode grpc
    reconnect_interval 10m

    GRPC {
        main_server {
            server grpc.example.com:9999
            ca /path/to/grpc/mtls/ca.pem
            certificate /path/to/grpc/mtls/client/cert.pem
            key /path/to/grpc/mtls/client/private.key
        }

        standby_server {
            server 192.168.1.2:9090
            ca /path/to/grpc/mtls/ca.pem
            certificate /path/to/grpc/mtls/client/cert.pem
            key /path/to/grpc/mtls/client/private.key
        }
    }

    certificate web {
        example.com
        *.example.com
    }

    certificate api {
        api.example.com
        *.api.example.com
    }
}

https://example.com {
    tls {
        get_certificate certdx web
    }

    root * /var/www/html
    file_server
}

https://api.example.com {
    tls {
        get_certificate certdx api
    }

    reverse_proxy localhost:3000
}
```

### Example 3: Multiple Certificates with HTTP Mode and Failover

```
{
    auto_https off
}

certdx {
    retry_count 5
    mode http

    http {
        main_server {
            url https://certdxserver.example.com:19198/api-path
            authMode token
            token your-primary-token
        }

        standby_server {
            url https://certdx-backup.example.com:19198/api-path
        }
    }

    certificate main {
        example.com
        www.example.com
    }

    certificate blog {
        blog.example.com
    }

    certificate shop {
        shop.example.com
    }
}

https://example.com {
    tls {
        get_certificate certdx main
    }

    reverse_proxy localhost:8080
}

https://blog.example.com {
    tls {
        get_certificate certdx blog
    }

    reverse_proxy localhost:8081
}

https://shop.example.com {
    tls {
        get_certificate certdx shop
    }

    reverse_proxy localhost:8082
}
```

---

## Common Configuration Scenarios

### Scenario 1: Single Site with Wildcard Certificate

```
{
    auto_https off
}

certdx {
    mode http

    http {
        main_server {
            url https://certdx.example.com:9999/api
            token your-token
        }
    }

    certificate wildcard {
        *.example.com
    }
}

https://example.com {
    tls {
        get_certificate certdx wildcard
    }

    file_server root /var/www
}
```

### Scenario 2: Development Environment with Test ACME Provider

Configure CertDX server with testing ACME provider (r3test or googletest), then use gRPC mode in Caddy:

```
certdx {
    mode grpc
    reconnect_interval 5m

    GRPC {
        main_server {
            server certdx-dev.local:9999
            ca /opt/caddy/mtls/ca.pem
            certificate /opt/caddy/mtls/caddy-dev.pem
            key /opt/caddy/mtls/caddy-dev.key
        }
    }

    certificate dev {
        dev.example.local
    }
}
```

### Scenario 3: High Availability Caddy Cluster

Multiple Caddy instances connecting to same CertDX server:

```
certdx {
    mode grpc
    reconnect_interval 5m

    GRPC {
        main_server {
            server certdx.example.com:9999
            ca /etc/caddy/certs/ca.pem
            certificate /etc/caddy/certs/caddy-node1.pem
            key /etc/caddy/certs/caddy-node1.key
        }
    }

    certificate shared {
        example.com
        *.example.com
    }
}

https://example.com {
    tls {
        get_certificate certdx shared
    }

    reverse_proxy localhost:8080
}
```

Each Caddy node should have its own client certificate (e.g., `caddy-node1.pem`, `caddy-node2.pem`, etc.).

---

## Security Best Practices

1. **Disable Auto HTTPS**: Always include `auto_https off` to prevent Caddy from attempting its own certificate management
2. **Token Security**: Use strong, randomly generated tokens for HTTP authentication
3. **mTLS Preferred**: For production, use gRPC mode with mTLS instead of token-based HTTP
4. **File Permissions**:
   - Private key files should be readable only by the Caddy process (e.g., `chmod 600`)
   - Caddy process user must have read permission to all certificate files
5. **Caddyfile Security**: Keep Caddyfile configuration files private if they contain tokens or sensitive information
6. **Certificate Paths**: Use absolute paths for certificate files; relative paths are relative to the directory where Caddy is running

---

## Troubleshooting

### Caddy Cannot Connect to CertDX Server

**HTTP Mode:**
- Verify `url` is correct and CertDX server is running
- Check firewall rules allow connection on specified port
- Verify `token` matches server configuration

**gRPC Mode:**
- Verify `server` address is reachable
- Check firewall rules allow connection on gRPC port
- Test with: `grpcurl -plaintext <server>:<port> list`

### Certificate Not Applied

- Verify certificate identifier is correct in `get_certificate` directive
- Check domains in certificate block are listed in CertDX server's `allowedDomains`
- Check Caddy logs for errors: `caddy logs`
- Verify CertDX server has issued the certificate

### mTLS Connection Fails

- Verify certificate and key files exist and are readable by Caddy process
- Check CA certificate matches CertDX server's CA
- Verify certificates are not expired: `openssl x509 -text -noout -in /path/to/cert.pem`
- Check file permissions: `ls -l /path/to/certs/`

### Certificate Not Renewing

- Check CertDX server certificate cache: `certdx_tools show-cache`
- Verify CertDX server is running and healthy
- Check reconnect interval: in gRPC mode, may need to reduce `reconnect_interval`
- Review CertDX server logs for renewal errors

---

## Relationship to Standalone Client Configuration

The Caddy plugin uses the same concepts as the standalone CertDX client, but expressed in Caddyfile syntax:

| Standalone Client (TOML) | Caddy Plugin (Caddyfile) |
|---|---|
| `[Common]` section | Global `certdx` block |
| `retryCount` | `retry_count` |
| `mode` | `mode` |
| `reconnectInterval` | `reconnect_interval` |
| `[Http.MainServer]` | `http { main_server { ... } }` |
| `[GRPC.MainServer]` | `GRPC { main_server { ... } }` |
| `[[Certifications]]` array | Multiple `certificate` blocks |
| Certificate `domains` | Domain lines in `certificate` block |
| Certificate `reloadCommand` | N/A (automatic reload via Caddy reload) |

---

## Reference

- [Caddy Documentation](https://caddyserver.com/docs/)
- [Caddy HTTPS Configuration](https://caddyserver.com/docs/caddyfile/directives/tls)
- [CertDX Server Configuration Wiki](SERVER_CONFIG_WIKI.md)
- [CertDX Standalone Client Wiki](CLIENT_CONFIG_WIKI.md)
